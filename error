FROM docker.repo1.uhc.com/alpine:latest AS base

ENV LANG=C.UTF-8
ENV TZ=UTC

# Use internal Alpine repo
RUN sed -i 's|https://dl-cdn.alpinelinux.org/alpine|http://docker.repo1.uhc.com/alpine|' /etc/apk/repositories

# Install basic packages
RUN apk add --no-cache \
  ca-certificates \
  python3 \
  zlib \
  bash \
  curl

# ---------- Builder Stage ----------
FROM base AS builder

# Use internal Alpine repo again
RUN sed -i 's|https://dl-cdn.alpinelinux.org/alpine|http://docker.repo1.uhc.com/alpine|' /etc/apk/repositories

RUN apk add --no-cache \
    git \
    python3-dev \
    py3-pyarrow \
    curl

WORKDIR /app

# Copy uv from ghcr
COPY --from=ghcr.io/astral-sh/uv:0.5.5 /uv /uvx /bin/

ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy
RUN uv venv --system-site-packages .venv

COPY uv.lock uv.lock
COPY pyproject.toml pyproject.toml

RUN uv sync --frozen --no-install-project --no-dev

COPY . /app

RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen \
        --extra test --extra webservice --extra watcher --no-dev \
        --no-install-package pyarrow

# ---------- Final Stage ----------
FROM base

# Use internal Alpine repo again
RUN sed -i 's|https://dl-cdn.alpinelinux.org/alpine|http://docker.repo1.uhc.com/alpine|' /etc/apk/repositories

# Install OCR and Java dependencies
RUN apk update && apk add --no-cache \
    ghostscript \
    jbig2dec \
    jbig2enc \
    pngquant \
    tesseract-ocr \
    tesseract-ocr-data-chi_sim \
    tesseract-ocr-data-deu \
    tesseract-ocr-data-eng \
    tesseract-ocr-data-fra \
    tesseract-ocr-data-osd \
    tesseract-ocr-data-por \
    tesseract-ocr-data-spa \
    ttf-droid \
    unpaper \
    openjdk17 \
    && rm -rf /var/cache/apk/*

# Set JAVA_HOME
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk
ENV PATH=$JAVA_HOME/bin:$PATH

# Create user and group
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

WORKDIR /app
RUN mkdir -p /app && chown appuser:appgroup /app

# Copy app from builder
COPY --from=builder --chown=appuser:appgroup /app /app

RUN rm -rf /app/.git && \
    ln -s /app/misc/webservice.py /app/webservice.py && \
    ln -s /app/misc/watcher.py /app/watcher.py

ENV PATH="/app/.venv/bin:${PATH}"

# Copy JAR and config
COPY target/linPdf-0.0.1-SNAPSHOT.jar app.jar
COPY target/application-docker.properties application.properties

EXPOSE 9040

ENTRYPOINT ["java", "-jar", "/app/app.jar"]
